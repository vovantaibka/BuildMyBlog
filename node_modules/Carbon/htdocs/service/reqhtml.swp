#!/usr/bin/env swordfish

require:(JSEval "require")
path   :(require "path")
D      :(.path "sep")

nodejs: (JSCallObject [$PATH_SWORDFISH "nodejs"] "join" D)
(load (+ nodejs D "package.sw"))
prime:(JSCallObject [$PATH_SWORDFISH "prime"] "join" D)
((. use "PushINC") prime true)
((. use "PushINC") "." (GetScriptURI))

(use "app.info"
"io.print"
"cgi.request"
"protocol.uri"
"io.print.error"
"cgi.response.errorstatus"
"script.string"
"io.file.write"
"io.file.readtext"
(lambda (AppInfo
Out
CGIRequest
URI
Error
CgiErrorStatus
SString
FileWrite
FileReadText
)

	
	os:(require "os")
	fs:(require "fs")
	encodeURI:(JSEval "encodeURI")
	sendErrorStatus:(. CgiErrorStatus "Send")

	Buffer:(JSEval "Buffer")
	process:(JSEval "process")
	Math:(JSEval "Math")
	JSON:(JSEval "JSON")

	env:(. process "env")
	body:((. CGIRequest "ReadBody"))
	params:((. CGIRequest "GetParameters") "UTF-8")
	direction:(. params "dir")
	nightMode:"null";(. params "nightMode")

	lpi:(. params "lpi")
	inRecitation:(. params "inRecitation")
	bodyStr:((. body "toString") "UTF-8")

	(Error "*\n")

	userAgent:((. CGIRequest "GetHeader") "User-Agent");
	isFirefox:(!(!(match userAgent `/Firefox[ \/]([\d.]+)/i)))

	tempdir:((. os "tmpdir"))
	randomFileName:(replace (+ "" ((. Math "random"))) `/^0\./ "1")
	outFilePath:(+ tempdir D randomFileName ".tmp")


	endCGIProcess:(lambda (@arguments)
		(Out "Content-type: text/plain; charset=UTF-8\n\n")
		(Out (+ "\"" randomFileName "\""))
			((. process "exit") 0 )
		)
	
	write:((. FileWrite "Get") outFilePath)
	(write 
		((. FileReadText "Get") "header01.html")
		((. FileReadText "Get") (+ ".." D "client" D "resources" D "javascript" D "h2eh56.js"))
		"pi.word.app.ehtml2html56.$(\"")
	(write bodyStr)
	(write "\",")
	(cond {lpi
			(write ((. JSON "stringify") lpi))
		}{default
			(write "null")
		})
	(write ",\"gray\","
		inRecitation
		",null"
		",\"" direction "\",null"
		"," nightMode
		",null,null);"
	)
	(write "</script></head><body onselectstart=\"return false;\" scroll=\"no\" bgcolor=\"#686868\" style=\"width:100%;height:100%;overflow:hidden;\">Your browser should enable javascript support.</body></html>")
	((. write "close"))
	(endCGIProcess)

))
